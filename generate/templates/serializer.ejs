import { BaseSerializer } from "./base.serializer";
import { api, env , port, url } from "../../config/environment.config";
import { SerializerParams } from "./serializerParams";
import { Request } from "express";
import { getRepository } from "typeorm";
<% foreignKeys.forEach(foreignKey => { %>
import { <%- capitalizeEntity(foreignKey.REFERENCED_TABLE_NAME) %>Serializer } from "./<%- lowercaseEntity(foreignKey.REFERENCED_TABLE_NAME) %>.serializer"
<% }); %>

export class <%- entityCapitalize %>Serializer extends BaseSerializer {

  public static withelist : Array<string> = [<%- allColumns %>];

  constructor(request : Request = null,totalCount : number = null) {
    let params = new SerializerParams();

    params
    .setAttributes(<%- entityCapitalize %>Serializer.withelist)
    <% foreignKeys.forEach(foreignKey => { %>
    .addRelation('<%- foreignKey.COLUMN_NAME %>', {
       ref : '<%- foreignKey.REFERENCED_COLUMN_NAME %>',
       attributes : <%- capitalizeEntity(foreignKey.REFERENCED_TABLE_NAME) %>Serializer.withelist,
       valueForRelationship : async (relationship) => {
          return await getRepository(<%- capitalizeEntity(foreignKey.REFERENCED_TABLE_NAME) %>).findOne(relationship.<%- foreignKey.COLUMN_NAME %>);
       }
      }
    ) <% }); %>
    .setDataLinks({
      self : (dataSet,data) => `${url}/api/${api}/${this.type}/${data.id}`
    });

    if (request && request.query.page && totalCount) {
      const page = parseInt(request.query.page.number);
      const size = request.query.page.size;
      const baseUrl = `${url}/api/${api}`;
      const max = Math.ceil(totalCount / size);

      params.setTopLevelLinks({
        self : () =>  `${baseUrl}/${this.type}${request.url}`,
        next : () => `${baseUrl}/${this.type}${this.replacePage(request.url,page + 1 > max ? max  : page + 1)}`,
        prev : () => `${baseUrl}/${this.type}${this.replacePage(request.url,page - 1 <   1 ? page : page - 1)}`,
        last : () => `${baseUrl}/${this.type}${this.replacePage(request.url,max)}` ,
        first : () =>  `${baseUrl}/${this.type}${this.replacePage(request.url,1)}`
      })
    }

    super('<%- pluralize.plural(entityLowercase) %>',params);
  }
}
