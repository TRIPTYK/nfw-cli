<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: generate/database/sqlAdaptator.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: generate/database/sqlAdaptator.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module sqlAdapatator
 * @author Verliefden Romain
 * @description this module provide method to get data from a sql database.
 * @exports getColumns
 * @exports getTables
 * @exports getTablesInName
 * @exports dropTable
 * @exports tableExists
 * @exports insertAdmin
 * @exports getForeignKeys
 * @exports dumpAll
 * @exports dumpTable
 * @exports Select
 * @exports checkConnexion
 */
const mysql = require('mysql');
const env = require('./databaseEnv');
const util = require('util');
const mysqldump = require('mysqldump');
const chalk = require('chalk');
const bcrypt = require('bcrypt');

var db = mysql.createConnection({
    host: env.host,
    user: env.user,
    password: env.pwd,
    database: env.database,
    port : env.port
});

const query = util.promisify(db.query.bind(db));


/**
 * @description : get table foreign keys
 * @param {string} tableName
 * @returns {Array} query results
 */
exports.getForeignKeys = async (tableName) => {
    let result = await query(`SELECT TABLE_NAME,COLUMN_NAME,CONSTRAINT_NAME,REFERENCED_TABLE_NAME,REFERENCED_COLUMN_NAME FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE WHERE REFERENCED_TABLE_SCHEMA='${env.database}' AND TABLE_NAME='${tableName}';`);
    return result;
};

/**
 * @description Generate a random password hash it, create a super user, write in in the database, then write the credential in a file
 * @param {string} username
 */
exports.insertAdmin = async (username) => {
  let password = "";
  let possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  for (var i = 0; i &lt; 24; i++)
    password += possible.charAt(Math.floor(Math.random() * possible.length));
  const hash = await bcrypt.hash(password, 10);
  let hashed = hash;
  await query(`INSERT INTO user(username, email, firstname, lastname, services, role, password) VALUES('${username}', '${username}@localhost.com','${username}','${username}','{}','admin', '${hashed}')`);
  return {
    login: `${username}@localhost.com`,
    password
  };
};

/**
 * @description : deletes a table
 * @param {string} tableName
 * @returns {Array} query results
 */
exports.dropTable = async (tableName) => {
  let result = await query(`DROP TABLE ${tableName};`);
  return result;
};

/**
 * @param {string} tableName
 * @description get all data related to columns of a table
 * @returns {Array} query results 
 */
exports.getColumns = async (tableName) => {
    let result = await query(`SHOW COLUMNS FROM ${tableName} ;`);
    return result;
};


/**
 * @description checks if table exists
 * @param {string} tableName
 * @returns {boolean} true/false
 */
exports.tableExists = async (tableName) => {
  let result = await query(  `
    SELECT COUNT(*) as 'count'
    FROM information_schema.tables
    WHERE table_schema = '${env.database}'
    AND table_name = '${tableName}';
  `).catch(e => [{count : false}]);
  return result[0].count > 0;
};

/**
 * @returns get all name of table in a database
 * @returns {Array} query results 
 */
exports.getTables = async () =>{
    result = await query(`SHOW TABLES`);
    return result;
}

/**
 * @description as name of table are given in a associative array where the field wich contains the table is Tables_In_dbName . i need this so that
 * i can get the correct field
 *
 * @returns {string} Tabls_in_dbName
 */
exports.getTablesInName = async () =>{
    let tableName = "Tables_in_"+env.database.replace('-','_');
    return tableName;
}


/**
 * @description dump all into file
 * @param {string} path
 */
exports.dumpAll = async (path) => {
  // dump the result straight to a file
  await mysqldump({
      connection: {
          host: env.host,
          user: env.user,
          password: env.pwd,
          database: env.database,
      },
      dumpToFile: path + '.sql',
  });
};

/**
* @description dump a table into file
* @param {string} table
* @param {string} path
 */
exports.dumpTable = async (table,path) => {
  // dump the result straight to a file
  await mysqldump({
      connection: {
          host: env.host,
          user: env.user,
          password: env.pwd,
          database: env.database,
      },
      dump : {
         tables : [table]
      },
      dumpToFile: path + '.sql',
  })
};

/**
* @description Select Fields from a table
* @param {Array.string} fields
* @param {string} table 
* @returns {Array} query results 
*/
exports.Select = async (fields,table) =>{
  let fieldValue='';
  fields.forEach(field => {
    fieldValue += field+",";
  });
  fieldValue = fieldValue.substr(0,fieldValue.length-1);
  result = await query(`SELECT ${fieldValue} from  ${table}`);
  return result;

}


/**
 * @description CHeck if the datapase if reachable, if not process exit with error message
 */
exports.checkConnexion = async  () => {
  const connect = util.promisify(db.connect.bind(db));
  await connect().catch(err => {
    if(err){
      console.log(chalk.red("Database is unreachable"));
      process.exit(0);
    } 
  });   
  return;
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-commands.html">commands</a></li><li><a href="module-databaseInfo.html">databaseInfo</a></li><li><a href="module-delete.html">delete</a></li><li><a href="module-draw.html">draw</a></li><li><a href="module-ErrorHandler.html">ErrorHandler</a></li><li><a href="module-files.html">files</a></li><li><a href="module-generateFromDB.html">generateFromDB</a></li><li><a href="module-index.html">index</a></li><li><a href="module-inquirer.html">inquirer</a></li><li><a href="module-modelSpecs.html">modelSpecs</a></li><li><a href="module-modelWrite.html">modelWrite</a></li><li><a href="module-New.html">New</a></li><li><a href="module-sqlAdapatator.html">sqlAdapatator</a></li><li><a href="module-test.html">test</a></li><li><a href="module-utils.html">utils</a></li></ul><h3>Classes</h3><ul><li><a href="module-delete.html">delete</a></li></ul><h3>Global</h3><ul><li><a href="global.html#chalk">chalk</a></li><li><a href="global.html#clear">clear</a></li><li><a href="global.html#databaseEnv">databaseEnv</a></li><li><a href="global.html#dotenv">dotenv</a></li><li><a href="global.html#FS">FS</a></li><li><a href="global.html#inquirer">inquirer</a></li><li><a href="global.html#items">items</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Fri Mar 29 2019 11:09:40 GMT+0100 (GMT+01:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
